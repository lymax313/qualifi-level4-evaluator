<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Qualifi Level 4 Evaluator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #f5f7fb;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 900px;
      margin: 40px auto;
      background: #ffffff;
      padding: 24px 28px 32px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }
    h1 {
      margin-top: 0;
      text-align: center;
      color: #1f2933;
    }
    .subtitle {
      text-align: center;
      color: #52606d;
      margin-bottom: 24px;
    }
    label {
      font-weight: 600;
      color: #323f4b;
      display: block;
      margin-bottom: 6px;
    }
    input[type="text"],
    input[type="file"],
    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #cbd2d9;
      font-size: 14px;
      box-sizing: border-box;
    }
    .row {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
    }
    .row .field {
      flex: 1;
    }
    .field {
      margin-bottom: 16px;
    }
    button {
      width: 100%;
      padding: 12px;
      background-color: #2563eb;
      border: none;
      color: #ffffff;
      font-size: 16px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
    }
    button:disabled {
      background-color: #9fb3c8;
      cursor: not-allowed;
    }
    .error {
      margin-top: 16px;
      padding: 10px 12px;
      border-radius: 6px;
      background-color: #fde8e8;
      color: #9b1c1c;
      font-size: 14px;
    }
    .success {
      margin-top: 16px;
      padding: 10px 12px;
      border-radius: 6px;
      background-color: #e3f9e5;
      color: #276749;
      font-size: 14px;
    }
    .result-card {
      margin-top: 24px;
      padding: 18px 20px;
      border-radius: 10px;
      background-color: #f0f9ff;
      border: 1px solid #bee3f8;
    }
    .result-header {
      font-weight: 700;
      margin-bottom: 10px;
      color: #1f2933;
    }
    .result-row {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-bottom: 4px;
      color: #323f4b;
    }
    .grade-banner {
      margin-top: 16px;
      padding: 12px 14px;
      text-align: center;
      border-radius: 8px;
      background-color: #e1effe;
      color: #1f2933;
      font-weight: 700;
      font-size: 16px;
    }
    .section-title {
      font-weight: 700;
      margin-top: 16px;
      margin-bottom: 6px;
      color: #1f2933;
    }
    .small-text {
      font-size: 13px;
      color: #52606d;
    }
    .pdf-button {
      margin-top: 16px;
      display: inline-block;
      padding: 10px 14px;
      border-radius: 6px;
      background-color: #2563eb;
      color: #ffffff;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Qualifi Level 4 Evaluator</h1>
    <p class="subtitle">Upload a rubric and learner assignment to generate an automated evaluation and PDF report.</p>

    <form id="evalForm">
      <div class="row">
        <div class="field">
          <label for="studentName">Student Name</label>
          <input type="text" id="studentName" name="student_name" required />
        </div>
        <div class="field">
          <label for="studentId">Student ID</label>
          <input type="text" id="studentId" name="student_id" required />
        </div>
      </div>

      <div class="field">
        <label for="unitTitle">Unit Title (include unit code e.g. AID 401)</label>
        <input type="text" id="unitTitle" name="unit_title" required />
      </div>

      <div class="field">
        <label for="rubricFile">Upload Rubric / Assignment Brief (.txt, .docx, .pdf)</label>
        <input type="file" id="rubricFile" name="rubric" accept=".txt,.pdf,.doc,.docx" required />
      </div>

      <div class="field">
        <label for="assignmentFile">Upload Assignment File (.txt, .pdf, .docx)</label>
        <input type="file" id="assignmentFile" name="assignment" accept=".txt,.pdf,.doc,.docx" required />
      </div>

      <button type="submit" id="submitBtn">Run Automated Evaluation</button>
    </form>

    <div id="message"></div>
    <div id="result"></div>
  </div>

  <script>
    const form = document.getElementById("evalForm");
    const submitBtn = document.getElementById("submitBtn");
    const messageDiv = document.getElementById("message");
    const resultDiv = document.getElementById("result");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      messageDiv.innerHTML = "";
      resultDiv.innerHTML = "";
      submitBtn.disabled = true;
      submitBtn.textContent = "Evaluating...";

      const formData = new FormData(form);

      try {
        const resp = await fetch("/api/evaluate", {
          method: "POST",
          body: formData,
        });

        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          throw new Error(err.detail || "Evaluation failed");
        }

        const data = await resp.json();

        messageDiv.innerHTML = '<div class="success">Evaluation complete. Review the details below.</div>';

        const evalData = data.data || {};
        const breakdown = evalData.mark_breakdown || {};
        const criteria = evalData.criteria_feedback || [];
        const pdfUrl = data.pdf_url;

        let breakdownHtml = "";
        for (const key in breakdown) {
          const item = breakdown[key];
          breakdownHtml += `
            <div class="small-text"><strong>${key}</strong>: ${item.score} — ${item.justification}</div>
          `;
        }

        let criteriaHtml = "";
        criteria.forEach((c) => {
          criteriaHtml += `
            <div class="small-text">
              <strong>${c.achieved ? "[ACHIEVED]" : "[NOT ACHIEVED]"} ${c.criterion}</strong><br/>
              Evidence: ${c.evidence}<br/>
              Improvement: ${c.improvement}
            </div>
            <hr/>
          `;
        });

        resultDiv.innerHTML = `
          <div class="result-card">
            <div class="result-header">Evaluation Complete</div>
            <div class="result-row">
              <span><strong>Student:</strong> ${data.student_name}</span>
              <span><strong>ID:</strong> ${data.student_id}</span>
            </div>
            <div class="result-row">
              <span><strong>Unit Title:</strong> ${data.unit_title}</span>
            </div>

            <div class="section-title">Learning Outcomes Assessment</div>
            <div class="small-text">
              Automated rubric-based scoring; see mark breakdown and criteria comments below.
            </div>

            <div class="section-title">Overall Feedback</div>
            <div class="small-text">
              ${evalData.overall_feedback || ""}
            </div>

            <div class="grade-banner">
              Overall Grade: ${evalData.grade || "N/A"} — ${evalData.total_score || 0}/220 (${evalData.percentage || 0}%)
            </div>

            <div class="section-title">Mark Scheme Breakdown</div>
            ${breakdownHtml}

            <div class="section-title">Assessment Criteria Feedback</div>
            ${criteriaHtml || '<div class="small-text">No detailed LO breakdown available.</div>'}

            ${
              pdfUrl
                ? `<a class="pdf-button" href="${pdfUrl}" target="_blank">Download PDF Report</a>`
                : ""
            }
          </div>
        `;
      } catch (err) {
        console.error(err);
        messageDiv.innerHTML = `<div class="error">${err.message}</div>`;
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Run Automated Evaluation";
      }
    });
  </script>
</body>
</html>
